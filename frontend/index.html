<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kaspa Mining Pool Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #111; color: #eee; }
    .card { background: #1e1e1e; border: none; }
    input { background: #333; color: #eee; border: 1px solid #444; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">Kaspa Pool Dashboard</h1>

    <div class="mb-4 text-center">
      <input id="addressInput" type="text" class="form-control w-50 d-inline" placeholder="kaspa:... (your wallet address)" />
      <button onclick="loadMinerStats()" class="btn btn-primary ms-2">Check</button>
    </div>

    <div id="minerStats" class="row g-3 mb-5 d-none">
      <div class="col-md-3"><div class="card p-3"><h5>Miner Hashrate</h5><p id="minerHashrate">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Shares</h5><p id="minerShares">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Last Payment</h5><p id="minerPayment">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Status</h5><p id="minerStatus">--</p></div></div>
    </div>

    <div class="row g-4">
      <div class="col-md-3"><div class="card p-3"><h5>Total Hashrate</h5><p id="hashrate">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Miners Connected</h5><p id="miners">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Blocks Found</h5><p id="blocks">--</p></div></div>
      <div class="col-md-3"><div class="card p-3"><h5>Last Payment</h5><p id="payment">--</p></div></div>
    </div>

    <canvas id="hashrateChart" class="mt-5"></canvas>
  </div>

  <script>
    let chart;
    const ctx = document.getElementById('hashrateChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array(10).fill(''),
        datasets: [{
          label: 'Pool Hashrate',
          data: Array(10).fill(0),
          borderColor: 'cyan',
          borderWidth: 2
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });

    async function fetchStats() {
      const res = await fetch('/api/stats');
      const data = await res.json();
      document.getElementById('hashrate').innerText = data.hashrate + ' H/s';
      document.getElementById('miners').innerText = data.miners;
      document.getElementById('blocks').innerText = data.blocksFound;
      document.getElementById('payment').innerText = data.lastPayment || "N/A";

      chart.data.datasets[0].data.push(data.hashrate);
      chart.data.datasets[0].data.shift();
      chart.update();
    }

    async function loadMinerStats() {
      const addr = document.getElementById("addressInput").value.trim();
      if (!addr.startsWith("kaspa:")) return alert("Adresse invalide");

      try {
        const res = await fetch(`/api/miner/${addr}`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        document.getElementById('minerHashrate').innerText = data.hashrate + ' H/s';
        document.getElementById('minerShares').innerText = data.shares;
        document.getElementById('minerPayment').innerText = data.lastPayment || 'N/A';
        document.getElementById('minerStatus').innerText = data.active ? 'Active' : 'Inactive';
        document.getElementById('minerStats').classList.remove("d-none");
      } catch {
        alert("Adresse inconnue ou erreur serveur");
      }
    }

    fetchStats();
    setInterval(fetchStats, 10000);
  </script>
</body>
</html>
